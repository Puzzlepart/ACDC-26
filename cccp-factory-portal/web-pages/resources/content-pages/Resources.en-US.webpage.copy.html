{% include 'api-wrapper' %}
{% fetchxml resourceData %}
<fetch>
  <entity name="ccc_resource">
    <attribute name="ccc_resourceid" />
    <attribute name="ccc_resourcename" />
    <attribute name="ccc_quantity" />
    <attribute name="ccc_priceperunit" />
    <filter type="and">
      <condition attribute="statecode" operator="eq" value="0" />
    </filter>
    <order attribute="ccc_resourcename" />
  </entity>
</fetch>
{% endfetchxml %}

<div class="container-fluid py-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold mb-0">Available Resources</h1>
      <button id="refreshDataBtn" class="btn cccp-refresh-btn" title="Refresh data">
        <i class="fa-solid fa-rotate-right"></i>
      </button>
    </div>
    
    <div id="alertContainer" class="mb-4"></div>
    
    <div class="row g-4">
      {% if resourceData.results.entities.size > 0 %}
        {% for resource in resourceData.results.entities %}
          {% assign resourceId = resource.ccc_resourceid %}
          {% assign resourceName = resource.ccc_resourcename %}
          {% assign quantity = resource.ccc_quantity | default: 0 %}
          {% assign pricePerUnit = resource.ccc_priceperunit | default: 0 %}
          {% assign resourceNameLower = resourceName | downcase %}
          
          {% comment %}Map resource names to icons{% endcomment %}
          {% case resourceNameLower %}
            {% when 'wheat' %}
              {% assign icon = 'ðŸŒ¾' %}
              {% assign cssClass = 'wheat' %}
            {% when 'potatoes', 'potato' %}
              {% assign icon = 'ðŸ¥”' %}
              {% assign cssClass = 'potato' %}
            {% when 'carrots', 'carrot' %}
              {% assign icon = 'ðŸ¥•' %}
              {% assign cssClass = 'carrot' %}
            {% else %}
              {% assign icon = 'ðŸ“¦' %}
              {% assign cssClass = 'default' %}
          {% endcase %}
          
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card cccp-card cccp-card-{{ cssClass }} h-100 shadow-sm">
              <div class="cccp-card-body">
                <div class="d-flex align-items-center mb-3">
                  <span class="me-2" style="font-size: 1.5rem;">{{ icon }}</span>
                  <h5 class="card-title mb-0 fw-bold">{{ resourceName }}</h5>
                </div>
                
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <small class="fw-semibold">Price per unit</small>
                    <small class="fw-bold">${{ pricePerUnit | round: 2 }}</small>
                  </div>
                  <div class="d-flex justify-content-between">
                    <small class="fw-semibold">Available Stock</small>
                    <small class="fw-bold">{{ quantity }} units</small>
                  </div>
                </div>
                
                {% if user %}
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Select Amount</label>
                    <input 
                      type="number" 
                      class="form-control quantity-input" 
                      min="1" 
                      max="{{ quantity }}"
                      value="1" 
                      data-resource-id="{{ resourceId }}"
                      data-resource-name="{{ resourceName }}" 
                      data-price="{{ pricePerUnit }}" 
                      data-stock="{{ quantity }}"
                      {% if quantity <= 0 %}disabled{% endif %}>
                  </div>
                  <button 
                    class="btn w-100 js-order-btn cccp-place-order-btn"
                    {% if quantity <= 0 %}disabled{% endif %}>
                    {% if quantity <= 0 %}
                      <i class="fa-solid fa-ban me-2"></i>Out of Stock
                    {% else %}
                      <i class="fa-solid fa-shopping-cart me-2"></i>Place Order
                    {% endif %}
                  </button>
                {% else %}
                  <div class="alert alert-warning mb-0">
                    <small><a href="/signin" class="alert-link">Sign in</a> to place orders</small>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="col-12">
          <div class="alert alert-warning">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>
            No resources available. Please contact support.
          </div>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- My Orders Section -->
  {% if user %}
  <div class="container mt-5 mb-5">
    <div class="cccp-orders-section">
      <div class="cccp-orders-header mb-4">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h3 class="mb-1 fw-bold" style="color: #1f2937;">
              <i class="fa-solid fa-receipt me-2" style="color: #991b1b;"></i>My Orders
            </h3>
            <p class="text-muted mb-0 small">View and track your order history</p>
          </div>
          <div class="cccp-orders-badge">
            <i class="fa-solid fa-box-archive"></i>
          </div>
        </div>
      </div>
      <div id="ordersContainer">
        <div class="text-center py-5">
          <div class="spinner-border text-danger" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-3">Loading your orders...</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

{% if user %}
<input type="hidden" id="userContactId" value="{{ user.id }}">
{% endif %}

<!-- Order Confirmation Modal -->
<div class="modal fade" id="orderConfirmModal" tabindex="-1" aria-labelledby="orderConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content cccp-modal">
      <div class="modal-header cccp-modal-header">
        <h5 class="modal-title fw-bold" id="orderConfirmModalLabel">
          <span id="modalIcon" class="me-2"></span>Confirm Your Order
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body cccp-modal-body">
        <div class="mb-4">
          <h6 class="text-muted mb-3 fw-semibold" style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Order Summary</h6>
          <div class="cccp-order-summary">
            <div class="d-flex justify-content-between mb-3 py-2">
              <span class="text-muted">Resource:</span>
              <span id="modalResourceName" class="fw-bold" style="color: #1f2937;"></span>
            </div>
            <div class="d-flex justify-content-between mb-3 py-2">
              <span class="text-muted">Quantity:</span>
              <span id="modalQuantity" class="fw-bold" style="color: #1f2937;"></span>
            </div>
            <div class="d-flex justify-content-between mb-3 py-2">
              <span class="text-muted">Price per unit:</span>
              <span id="modalPricePerUnit" class="fw-bold" style="color: #1f2937;"></span>
            </div>
            <div class="cccp-modal-divider"></div>
            <div class="d-flex justify-content-between align-items-center pt-3">
              <span class="fw-bold" style="font-size: 1.15rem; color: #1f2937;">Total Price:</span>
              <span id="modalTotalPrice" class="cccp-total-price"></span>
            </div>
          </div>
        </div>
        <div class="cccp-info-badge">
          <i class="fa-solid fa-info-circle me-2"></i>
          <span>Your order will be processed immediately upon confirmation.</span>
        </div>
      </div>
      <div class="modal-footer cccp-modal-footer">
        <button type="button" class="btn cccp-btn-cancel" data-bs-dismiss="modal">
          <i class="fa-solid fa-times me-2"></i>Cancel
        </button>
        <button type="button" class="btn cccp-btn-confirm" id="confirmOrderBtn">
          <i class="fa-solid fa-check me-2"></i>Confirm Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content cccp-modal">
      <div class="modal-header cccp-modal-header">
        <h5 class="modal-title fw-bold" id="orderDetailsModalLabel">
          <i class="fa-solid fa-file-invoice me-2" style="color: #991b1b;"></i>Order Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body cccp-modal-body">
        <div id="orderDetailsContent">
          <div class="text-center py-5">
            <div class="spinner-border" style="color: #991b1b; width: 3rem; height: 3rem;" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3 mb-0">Loading order details...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer cccp-modal-footer">
        <button type="button" class="btn cccp-btn-close" data-bs-dismiss="modal">
          <i class="fa-solid fa-times me-2"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Modern Place Order Button Styling */
  .cccp-place-order-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }
  
  .cccp-place-order-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
  }
  
  .cccp-place-order-btn:active:not(:disabled) {
    transform: translateY(0);
  }
  
  .cccp-place-order-btn:disabled {
    background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
    box-shadow: none;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .cccp-place-order-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
  }
  
  /* Refresh Button Styling */
  .cccp-refresh-btn {
    background: white;
    border: 2px solid #e5e7eb;
    color: #6b7280;
    width: 42px;
    height: 42px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0;
    font-size: 1.1rem;
  }
  
  .cccp-refresh-btn:hover {
    background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
    border-color: #991b1b;
    color: white;
    transform: rotate(180deg);
    box-shadow: 0 4px 12px rgba(153, 27, 27, 0.3);
  }
  
  .cccp-refresh-btn:active {
    transform: rotate(180deg) scale(0.95);
  }
  
  .cccp-refresh-btn.loading {
    pointer-events: none;
    opacity: 0.7;
  }
  
  .cccp-refresh-btn.loading i {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
  
  /* Modern Modal Styling */
  .cccp-modal .modal-content {
    border: 3px solid #991b1b;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
  }
  
  .cccp-modal-header {
    background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
    border-bottom: 4px solid #facc15;
    padding: 1.5rem 2rem;
    position: relative;
  }
  
  .cccp-modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, #facc15, transparent);
    animation: shimmer 3s infinite;
  }
  
  @keyframes shimmer {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }
  
  .cccp-modal-header .modal-title {
    color: white;
    font-size: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .cccp-modal-header .btn-close {
    background: transparent;
    border: 2px solid #facc15;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    padding: 0;
    opacity: 1;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    filter: brightness(0) invert(1);
  }
  
  .cccp-modal-header .btn-close:hover {
    background: #facc15;
    transform: rotate(90deg) scale(1.1);
    border-color: #facc15;
  }
  
  .cccp-modal-body {
    padding: 2rem;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
  }
  
  .cccp-order-summary {
    background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
    border-radius: 12px;
    padding: 1.5rem;
    border-left: 4px solid #facc15;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }
  
  .cccp-modal-divider {
    height: 2px;
    background: linear-gradient(90deg, transparent 0%, #e5e7eb 20%, #e5e7eb 80%, transparent 100%);
    margin: 1rem 0;
  }
  
  .cccp-total-price {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .cccp-info-badge {
    background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
    border-left: 4px solid #3b82f6;
    border-radius: 8px;
    padding: 0.875rem 1rem;
    font-size: 0.875rem;
    color: #1e40af;
    display: flex;
    align-items: center;
  }
  
  .cccp-info-badge i {
    color: #3b82f6;
    font-size: 1rem;
  }
  
  .cccp-modal-footer {
    background: white;
    border-top: 2px solid #e5e7eb;
    padding: 1.25rem 2rem;
    gap: 0.75rem;
  }
  
  /* Modal Buttons */
  .cccp-btn-cancel {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
  }
  
  .cccp-btn-cancel:hover {
    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(107, 114, 128, 0.4);
    color: white;
  }
  
  .cccp-btn-cancel:active {
    transform: translateY(0);
  }
  
  .cccp-btn-confirm {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  .cccp-btn-confirm:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4);
    color: white;
  }
  
  .cccp-btn-confirm:active {
    transform: translateY(0);
  }
  
  .cccp-btn-close {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.75rem 2rem;
    border-radius: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
  }
  
  .cccp-btn-close:hover {
    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(107, 114, 128, 0.4);
    color: white;
  }
  
  .cccp-btn-close:active {
    transform: translateY(0);
  }
  
  /* Modal Animation */
  .modal.fade .modal-dialog {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-out;
  }
  
  .modal.show .modal-dialog {
    animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  @keyframes modalSlideIn {
    from {
      transform: translateY(-50px) scale(0.95);
      opacity: 0;
    }
    to {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }
  
  /* My Orders Section Styling */
  .cccp-orders-section {
    background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .cccp-orders-header {
    position: relative;
  }
  
  .cccp-orders-badge {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #facc15;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(153, 27, 27, 0.3);
  }
  
  .order-item {
    background: white;
    border: none !important;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
    position: relative;
  }
  
  .order-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, #991b1b 0%, #7f1d1d 100%);
  }
  
  .order-item:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }
  
  .order-item:active {
    transform: translateY(-2px) scale(1.005);
  }
  
  .order-item .card-body {
    padding: 1.25rem 1.5rem;
    background: linear-gradient(90deg, rgba(254, 243, 199, 0.15) 0%, transparent 100%);
  }
  
  .order-item h6 {
    color: #1f2937;
    font-size: 1rem;
  }
  
  .order-item .badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.75rem;
    font-weight: 600;
    border-radius: 6px;
  }
  
  .order-item .fa-chevron-right {
    color: #991b1b;
    transition: transform 0.2s;
  }
  
  .order-item:hover .fa-chevron-right {
    transform: translateX(4px);
  }
  
  /* Empty state styling */
  .cccp-orders-empty {
    text-align: center;
    padding: 3rem 1rem;
    background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
    border-radius: 12px;
    border: 2px dashed #d8b15a;
  }
  
  .cccp-orders-empty i {
    font-size: 4rem;
    color: #d8b15a;
    margin-bottom: 1rem;
    opacity: 0.8;
  }
  
  .cccp-orders-empty p {
    color: #78716c;
    font-size: 1.1rem;
    margin: 0;
  }
  
  /* Order Details Modal Content Styling */
  .cccp-detail-card {
    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
    border-radius: 12px;
    padding: 1.25rem;
    border-left: 4px solid #3b82f6;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }
  
  .detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(229, 231, 235, 0.5);
  }
  
  .detail-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .detail-label {
    color: #6b7280;
    font-size: 0.9rem;
    font-weight: 500;
  }
  
  .detail-label i {
    color: #9ca3af;
    width: 20px;
    text-align: center;
  }
  
  .detail-value {
    color: #1f2937;
    font-weight: 600;
    font-size: 0.95rem;
  }
  
  .cccp-items-card {
    background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
    border-radius: 12px;
    padding: 1rem;
    border-left: 4px solid #facc15;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }
  
  .order-line-item {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .order-line-item:hover {
    background: rgba(255, 255, 255, 0.5);
    margin: 0 -1rem;
    padding: 0 1rem;
    border-radius: 8px;
  }
  
  .order-line-icon {
    font-size: 1.25rem;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }
  
  .order-total-section {
    margin-top: 1rem;
    padding-top: 1.25rem;
    border-top: 2px solid rgba(217, 119, 6, 0.2);
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.4) 100%);
    margin: 1rem -1rem -1rem;
    padding: 1.25rem 1rem 1rem;
    border-radius: 0 0 8px 8px;
  }
</style>

<!-- Load utilities first -->
<script src="~/utils.js"></script>

<script>
  (() => {
    'use strict';

    // =============================================================================
    // IMPORT UTILITIES
    // =============================================================================
    const { ApiUtils, UiUtils, DateUtils, CONFIG } = window.ProjectUtils;

    // =============================================================================
    // DOM ELEMENTS
    // =============================================================================
    const elements = {
      get userContactId() { return document.getElementById('userContactId')?.value; },
      get orderButtons() { return document.querySelectorAll('.js-order-btn'); },
      get modal() { return document.getElementById('orderConfirmModal'); },
      get confirmBtn() { return document.getElementById('confirmOrderBtn'); },
      get modalHeader() { return document.getElementById('modalHeader'); },
      get modalIcon() { return document.getElementById('modalIcon'); },
      get modalResourceName() { return document.getElementById('modalResourceName'); },
      get modalQuantity() { return document.getElementById('modalQuantity'); },
      get modalPricePerUnit() { return document.getElementById('modalPricePerUnit'); },
      get modalTotalPrice() { return document.getElementById('modalTotalPrice'); },
      get ordersContainer() { return document.getElementById('ordersContainer'); },
      get orderDetailsModal() { return document.getElementById('orderDetailsModal'); },
      get orderDetailsContent() { return document.getElementById('orderDetailsContent'); }
    };

    // Store current order data for confirmation
    let pendingOrder = null;

    // Early return if user is not logged in
    if (!elements.userContactId) {
      console.log('User not logged in - order functionality disabled');
      return;
    }

    // =============================================================================
    // FUNCTIONS
    // =============================================================================

    /**
     * Handle order placement button click - show confirmation modal
     * @param {Event} event - Click event
     */
    async function handlePlaceOrder(event) {
      const button = event.currentTarget;
      const input = button.closest('.cccp-card-body').querySelector('.quantity-input');
      
      if (!input) {
        console.error('Quantity input not found');
        return;
      }

      const resourceId = input.dataset.resourceId;
      const resourceName = input.dataset.resourceName;
      const quantity = parseInt(input.value, 10);
      const stock = parseInt(input.dataset.stock, 10);
      const pricePerUnit = parseFloat(input.dataset.price);
      
      // Get icon from the card
      const card = button.closest('.cccp-card');
      const icon = card.querySelector('.card-title').parentElement.querySelector('span').textContent;
      const cssClass = card.className.match(/cccp-card-(\w+)/)?.[1] || 'default';

      // Validate quantity
      if (!quantity || quantity < 1) {
        UiUtils.showAlert('Please enter a valid quantity', 'warning');
        return;
      }

      if (quantity > stock) {
        UiUtils.showAlert(`Only ${stock} units available`, 'warning');
        return;
      }

      // Calculate total price
      const totalPrice = quantity * pricePerUnit;

      // Store pending order data
      pendingOrder = {
        resourceId,
        resourceName,
        quantity,
        pricePerUnit,
        totalPrice,
        button,
        input,
        icon,
        cssClass
      };

      // Populate modal
      elements.modalResourceName.textContent = resourceName;
      elements.modalQuantity.textContent = `${quantity} unit${quantity > 1 ? 's' : ''}`;
      elements.modalPricePerUnit.textContent = `$${pricePerUnit.toFixed(2)}`;
      elements.modalTotalPrice.textContent = `$${totalPrice.toFixed(2)}`;
      
      // Update modal icon
      elements.modalIcon.textContent = icon;

      // Show modal
      const modal = new bootstrap.Modal(elements.modal);
      modal.show();
    }

    /**
     * Handle order confirmation - actually create the order
     */
    async function handleConfirmOrder() {
      if (!pendingOrder) return;

      const { resourceId, resourceName, quantity, pricePerUnit, button, input } = pendingOrder;

      // Hide modal
      const modalInstance = bootstrap.Modal.getInstance(elements.modal);
      if (modalInstance) {
        modalInstance.hide();
      }

      // Set loading state
      UiUtils.setButtonLoading(button, true);

      try {
        // Build order data
        const orderData = {
          ccc_ordername: `${resourceName} - ${DateUtils.formatDate(new Date())}`,
          contactId: elements.userContactId,
          ccc_orderdate: "2026-01-23" // Hardcoded date as requested
        };

        // Step 1: Create the order
        const orderId = await ApiUtils.createOrder(orderData);
        console.log('Order created:', orderId);

        // Step 2: Create the order line
        const orderLineData = {
          resourceId: resourceId,
          quantity: quantity,
          pricePerUnit: pricePerUnit
        };
        const orderLineId = await ApiUtils.createOrderLine(orderId, orderLineData);
        console.log('Order line created:', orderLineId);

        // Step 3: Update resource quantity
        const currentStock = parseInt(input.dataset.stock, 10);
        const newStock = currentStock - quantity;
        await ApiUtils.updateResourceQuantity(resourceId, newStock);
        console.log('Resource quantity updated:', newStock);

        // Update the UI to reflect new stock
        input.dataset.stock = newStock;
        input.max = newStock;
        const stockDisplay = button.closest('.cccp-card-body').querySelector('.fw-bold:last-child');
        if (stockDisplay) {
          stockDisplay.textContent = `${newStock} units`;
        }

        // Show success message
        UiUtils.showAlert(`Order placed successfully for ${quantity} unit(s) of ${resourceName}!`, 'success');

        // Dispatch custom event (for potential listeners)
        document.dispatchEvent(new CustomEvent(CONFIG.EVENTS.ORDER_CREATED, {
          detail: { 
            orderId, 
            resourceId, 
            resourceName,
            quantity 
          }
        }));

        // Reset quantity input
        input.value = 1;

        // Clear pending order
        pendingOrder = null;
        
        // Reload orders list to show the new order
        await loadOrders();

      } catch (error) {
        console.error('Order placement failed:', error);
        UiUtils.showAlert('Failed to place order. Please try again.', 'danger');
      } finally {
        UiUtils.setButtonLoading(button, false);
      }
    }

    /**
     * Load and display user's orders
     */
    async function loadOrders() {
      try {
        const orders = await ApiUtils.getOrdersByContact(elements.userContactId);
        renderOrders(orders);
      } catch (error) {
        console.error('Failed to load orders:', error);
        elements.ordersContainer.innerHTML = `
          <div class="alert alert-danger">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            Failed to load orders. Please refresh the page.
          </div>
        `;
      }
    }

    /**
     * Render orders to the container
     * @param {Array} orders - Array of order objects
     */
    function renderOrders(orders) {
      if (!elements.ordersContainer) return;

      if (orders.length === 0) {
        elements.ordersContainer.innerHTML = `
          <div class="cccp-orders-empty">
            <i class="fa-solid fa-box-open"></i>
            <p class="fw-semibold">No orders yet</p>
            <p class="text-muted small mt-2">Place your first order above to get started!</p>
          </div>
        `;
        return;
      }

      const ordersHtml = orders.map(order => {
        const orderDate = new Date(order.createdon);
        const formattedDate = DateUtils.formatDate(orderDate);
        
        // Determine status badge color
        const statusLabel = order['statuscode@OData.Community.Display.V1.FormattedValue'] || 'Unknown';
        const statusLower = statusLabel.toLowerCase();
        let statusGradient, statusIcon;
        if (statusLower.includes('reject') || statusLower.includes('cancel')) {
          statusGradient = 'linear-gradient(135deg, #f87171 0%, #ef4444 100%)';
          statusIcon = 'fa-circle-xmark';
        } else if (statusLower.includes('pending') || statusLower.includes('wait')) {
          statusGradient = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
          statusIcon = 'fa-clock';
        } else if (statusLower.includes('sign') || statusLower.includes('complete') || statusLower.includes('success') || statusLower.includes('approve')) {
          statusGradient = 'linear-gradient(135deg, #34d399 0%, #10b981 100%)';
          statusIcon = 'fa-circle-check';
        } else {
          statusGradient = 'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)';
          statusIcon = 'fa-circle-info';
        }
        
        return `
          <div class="order-item mb-3" 
               data-order-id="${order.ccc_orderid}"
               style="cursor: pointer;">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                  <h6 class="mb-2 fw-bold">${UiUtils.escapeHtml(order.ccc_ordername)}</h6>
                  <div class="d-flex align-items-center gap-3">
                    <small class="text-muted">
                      <i class="fa-solid fa-calendar me-1"></i>${formattedDate}
                    </small>
                    <span class="badge" style="background: ${statusGradient}; padding: 0.4rem 0.75rem;">
                      <i class="fa-solid ${statusIcon} me-1"></i>${statusLabel}
                    </span>
                  </div>
                </div>
                <div class="ms-3">
                  <i class="fa-solid fa-chevron-right"></i>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      elements.ordersContainer.innerHTML = ordersHtml;

      // Add click handlers
      document.querySelectorAll('.order-item').forEach(item => {
        item.addEventListener('click', handleOrderClick);
      });
    }

    /**
     * Handle order item click - show details modal
     * @param {Event} event - Click event
     */
    async function handleOrderClick(event) {
      const orderId = event.currentTarget.dataset.orderId;
      
      // Show modal with loading state
      elements.orderDetailsContent.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;
      
      const modal = new bootstrap.Modal(elements.orderDetailsModal);
      modal.show();

      try {
        const { order, orderLines } = await ApiUtils.getOrderDetails(orderId);
        renderOrderDetails(order, orderLines);
      } catch (error) {
        console.error('Failed to load order details:', error);
        elements.orderDetailsContent.innerHTML = `
          <div class="alert alert-danger">
            <i class="fa-solid fa-exclamation-triangle me-2"></i>
            Failed to load order details. Please try again.
          </div>
        `;
      }
    }

    /**
     * Render order details in modal
     * @param {Object} order - Order object
     * @param {Array} orderLines - Order lines array
     */
    function renderOrderDetails(order, orderLines) {
      const orderDate = order.ccc_orderdate ? DateUtils.formatDate(order.ccc_orderdate) : 'N/A';
      const createdDate = DateUtils.formatDate(order.createdon);
      
      // Determine status badge color
      const statusLabel = order['statuscode@OData.Community.Display.V1.FormattedValue'] || 'Unknown';
      const statusLower = statusLabel.toLowerCase();
      let statusGradient, statusIcon;
      if (statusLower.includes('reject') || statusLower.includes('cancel')) {
        statusGradient = 'linear-gradient(135deg, #f87171 0%, #ef4444 100%)';
        statusIcon = 'fa-circle-xmark';
      } else if (statusLower.includes('pending') || statusLower.includes('wait')) {
        statusGradient = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
        statusIcon = 'fa-clock';
      } else if (statusLower.includes('sign') || statusLower.includes('complete') || statusLower.includes('success') || statusLower.includes('approve')) {
        statusGradient = 'linear-gradient(135deg, #34d399 0%, #10b981 100%)';
        statusIcon = 'fa-circle-check';
      } else {
        statusGradient = 'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)';
        statusIcon = 'fa-circle-info';
      }
      
      // Calculate total
      const total = orderLines.reduce((sum, line) => sum + (line.ccc_orderlineprice || 0), 0);

      const linesHtml = orderLines.map((line, index) => {
        const resourceName = line.ccc_resource?.ccc_resourcename || 'Unknown Resource';
        const quantity = line.ccc_quantity || 0;
        const price = line.ccc_orderlineprice || 0;
        const pricePerUnit = line.ccc_resource?.ccc_priceperunit || 0;
        const isLast = index === orderLines.length - 1;

        return `
          <div class="order-line-item ${isLast ? '' : 'border-bottom'}">
            <div class="d-flex justify-content-between align-items-center py-3">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <span class="order-line-icon me-2">ðŸ“¦</span>
                  <span class="fw-semibold" style="color: #1f2937; font-size: 1rem;">${UiUtils.escapeHtml(resourceName)}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-light text-dark border">
                    <i class="fa-solid fa-box me-1"></i>${quantity} units
                  </span>
                  <span class="text-muted small">Ã— $${pricePerUnit.toFixed(2)}</span>
                </div>
              </div>
              <div class="text-end">
                <div class="fw-bold" style="color: #991b1b; font-size: 1.1rem;">$${price.toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      elements.orderDetailsContent.innerHTML = `
        <div class="mb-4">
          <h6 class="text-muted mb-3 fw-semibold" style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">
            <i class="fa-solid fa-info-circle me-2" style="color: #3b82f6;"></i>Order Information
          </h6>
          <div class="cccp-detail-card">
            <div class="detail-row">
              <span class="detail-label">
                <i class="fa-solid fa-tag me-2"></i>Order Name
              </span>
              <span class="detail-value">${UiUtils.escapeHtml(order.ccc_ordername)}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">
                <i class="fa-solid fa-calendar me-2"></i>Order Date
              </span>
              <span class="detail-value">${orderDate}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">
                <i class="fa-solid fa-clock me-2"></i>Created
              </span>
              <span class="detail-value">${createdDate}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">
                <i class="fa-solid fa-circle-check me-2"></i>Status
              </span>
              <span class="detail-value">
                <span class="badge" style="background: ${statusGradient}; padding: 0.4rem 0.75rem; border-radius: 6px;">
                  <i class="fa-solid ${statusIcon} me-1"></i>${statusLabel}
                </span>
              </span>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <h6 class="text-muted mb-3 fw-semibold" style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">
            <i class="fa-solid fa-boxes-stacked me-2" style="color: #facc15;"></i>Order Items
          </h6>
          <div class="cccp-items-card">
            ${linesHtml}
            <div class="order-total-section">
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold" style="font-size: 1.15rem; color: #1f2937;">Total Amount:</span>
                <span class="cccp-total-price" style="font-size: 1.75rem;">$${total.toFixed(2)}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // =============================================================================
    // EVENT LISTENERS
    // =============================================================================
    function initialize() {
      console.log('Initializing order functionality...');
      
      // Add click handlers to all order buttons
      elements.orderButtons.forEach(button => {
        button.addEventListener('click', handlePlaceOrder);
      });

      // Add confirm button handler
      if (elements.confirmBtn) {
        elements.confirmBtn.addEventListener('click', handleConfirmOrder);
      }

      // Load user's orders
      if (elements.ordersContainer) {
        loadOrders();
      }

      // Add refresh button handler
      const refreshBtn = document.getElementById('refreshDataBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', handleRefresh);
      }

      console.log(`âœ… ${elements.orderButtons.length} order button(s) initialized`);
    }

    /**
     * Handle refresh button click - reload page data
     */
    function handleRefresh() {
      const refreshBtn = document.getElementById('refreshDataBtn');
      if (!refreshBtn) return;

      // Add loading state
      refreshBtn.classList.add('loading');
      refreshBtn.disabled = true;

      // Show loading message
      UiUtils.showAlert('Refreshing data...', 'info');

      // Reload the page after a brief delay to show the loading state
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }

    // =============================================================================
    // INITIALIZATION
    // =============================================================================
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
  })();
</script>