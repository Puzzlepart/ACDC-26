 {% assign defaultlang = settings['LanguageLocale/Code'] | default: 'en-us' %}
{% assign homeurl = website.adx_partialurl %}
<div class='cccp-header navbar-expand-xl navbar navbar-dark static-top' style="flex-wrap:wrap;" role='banner'>
  <div class='skip-to-content'>
    <a href='#mainContent'>{{ resx.Skip_To_Content | default: 'Skip to main content' }}</a>
  </div>
  <div class='container custom-container'>
    <!-- Logo/Title Row -->
    <div class='d-flex justify-content-between align-items-center w-100 cccp-header-top'>
      <div class='navbar-brand navbar-header cccp-header-brand'>
        {% editable snippets 'Mobile Header' type: 'html' %}
      </div>
      <button type='button' class='navbar-toggler collapsed custom-navbar-toggler' title='{{ snippets["Header/Toggle Navigation"] | default: resx['Toggle_Navigation'] | h }}' data-bs-toggle='collapse' data-bs-target='#navbar' aria-expanded='false' onclick='setHeight();'>
        <span class='visually-hidden'>{{ snippets['Header/Toggle Navigation'] | default: resx.Toggle_Navigation | h }}</span>
        <span class='navbar-toggler-icon'></span>
      </button>
    </div>

    <!-- Navigation Row -->
    <div id='navbar' class='navbar-collapse collapse cccp-nav-wrapper'>
      {% assign primary_nav = weblinks.Default %}
      {% if primary_nav %}
        <nav aria-label='{{ resx.Main_Navigation | default: "Main Navigation" }}' class='d-flex justify-content-between align-items-center w-100 cccp-nav {% if primary_nav.editable %}xrm-entity xrm-editable-adx_weblinkset{% endif %}' data-weblinks-maxdepth='2'>
          <!-- Left side: Page links -->
          <ul class='nav navbar-nav weblinks cccp-nav-list'>
            {% for link in primary_nav.weblinks %}
              {% if link.display_page_child_links %}
                {% if link.url != null %}
                  {% assign sublinks = sitemap[link.url].children %}
                {% endif %}
              {% else %}
                {% assign sublinks = link.weblinks %}
              {% endif %}
              <li class='nav-item weblink cccp-nav-item {% if sublinks.size > 0 %}dropdown{% endif %}'>
                <a
                  class='nav-link text-uppercase fw-semibold'a
                  aria-label='{{ link.name | escape }}'
                  {% if sublinks.size > 0 -%}
                    href='#' role='button' class='dropdown-toggle' data-bs-toggle='dropdown'
                  {%- else -%}
                    href='{{ link.url | escape }}' aria-roledescription='link'
                  {%- endif -%}
                  {%- if link.Open_In_New_Window %}
                    target='_blank'
                  {% endif -%}
                  {%- if link.nofollow %}
                    rel='nofollow'
                  {% endif -%}
                  {%- if link.tooltip %}
                    title='{{ link.tooltip | escape }}'
                  {% endif %}
                >
                  {%- if link.image -%}
                    {%- if link.image.url -%}
                      {%- if link.image.url.first == '.' -%}
                        <span class='{{ link.image.url | split:'.' | join }}' aria-hidden='true'></span>
                      {%- endif -%}
                    {%- else -%}
                      <img
                        src='{{ link.image.url | escape }}'
                        alt='{{ link.image.alternate_text | default:link.tooltip | escape }}'
                        {% if link.image.width %}
                          width='{{ link.image.width | escape }}'
                        {% endif %}
                        {% if link.image.height %}
                          height='{{ link.image.height | escape }}'
                        {% endif %}
                      >
                    {%- endif -%}
                  {%- endif -%}
                  {%- unless link.display_image_only -%}
                    {{ link.name | escape }}
                  {%- endunless -%}
                  {%- if sublinks.size > 0 -%}
                    <span class='caret'></span>
                  {%- endif -%}
                </a>
                {% if sublinks.size > 0 %}
                  <ul class='dropdown-menu dropdown-menu-end'>
                    {% if link.name %}
                      <li>
                        <a
                          aria-label='{{ link.name | escape }}'
                          class='dropdown-item'
                          aria-roledescription='link'
                          href='{{ link.url }}'
                          {% if link.Open_In_New_Window %}
                            target='_blank'
                          {% endif %}
                          {% if link.nofollow %}
                            rel='nofollow'
                          {% endif %}
                          {% if link.tooltip %}
                            title='{{ link.tooltip | escape }}'
                          {% endif %}
                        >
                          {{- link.name | escape -}}
                        </a>
                      </li>
                      <div class='dropdown-divider'></div>
                    {% endif %}
                    {% for sublink in sublinks %}
                      <li>
                        <a
                          class='dropdown-item'
                          aria-label='{{ sublink.name | default:sublink.title | escape }}'
                          aria-roledescription='link'
                          href='{{ sublink.url }}'
                          {% if sublink.Open_In_New_Window %}
                            target='_blank'
                          {% endif %}
                          {% if sublink.nofollow %}
                            rel='nofollow'
                          {% endif %}
                          {% if sublink.tooltip %}
                            title='{{ sublink.tooltip | escape }}'
                          {% endif %}
                        >
                          {{ sublink.name | default: sublink.title | escape }}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
          
          <!-- Right side: Search, Language, and Sign in/Profile -->
          <ul class='nav navbar-nav ms-auto cccp-nav-utilities'>
            {% assign search_enabled = settings['Search/Enabled'] | boolean | default: true %}
            {% if search_enabled %}
              <li class=' nav-item'>
                <a id='search' class=' nav-link navbar-icon' href='#' data-bs-toggle='modal' data-bs-target='#searchModal' role='button' aria-label='{{ snippets["Header/Search/ToolTip"] | default:resx["Search_DefaultText"] | escape }}'>
                  <span class='glyphicon fa-solid fa-magnifying-glass'></span>
                </a>
              </li>
            {% endif %}
            {% if website.languages.size > 1 %}
              <li class=' nav-item dropdown'>
                <a class=' nav-link dropdown-toggle' aria-roledescription='link' href='#' data-bs-toggle='dropdown' aria-label='{{ website.selected_language.name | escape }}' aria-haspopup='true' aria-expanded='false' title='{{ website.selected_language.name | escape }}'>
                  <span class='drop_language'>{{ website.selected_language.name | escape }}</span>
                  <span class='caret'></span>
                </a>
                {% include 'Languages Dropdown' %}
              </li>
            {% endif %}
            {% if user %}
              <li class=' nav-item dropdown'>
                {% assign username = user.fullname | escape %}
                <a href='#' class=' nav-link dropdown-toggle' aria-roledescription='link' title='{{username | default: resx['Default_Profile_name'] }}' data-bs-toggle='dropdown' role='button' aria-expanded='false'>
                  <span class='username'>{{ username | default: resx.Default_Profile_name }}</span>
                  <span class='caret'></span>
                </a>
                <ul class='dropdown-menu dropdown-menu-end'>
                  {% assign show_profile_nav = settings['Header/ShowAllProfileNavigationLinks'] | boolean | default: true %}
                  {% if show_profile_nav %}
                    {% assign profile_nav = weblinks['Profile Navigation'] %}
                    {% if profile_nav %}
                      {% for link in profile_nav.weblinks %}
                        <li>
                          <a class="dropdown-item"  aria-label='{{ link.name | escape }}' aria-roledescription='link' href='{{ link.url | escape }}' title='{{ link.name | escape }}'>{{ link.name | escape }}</a>
                        </li>
                      {% endfor %}
                    {% endif %}
                  {% else %}
                    <li>
                      <a class="dropdown-item"  aria-label='{{ snippets["Profile Link Text"] | default:resx["Profile_Text"] | escape }}' aria-roledescription='link' href='{{ sitemarkers['Profile'].url | escape }}'>{{ snippets['Profile Link Text'] | default: resx.Profile_Text | escape }}</a>
                    </li>
                  {% endif %}
                  <li class='dropdown-divider' role='separator' aria-hidden='true'></li>
                  <li>
                    <a class="dropdown-item"  aria-label='{{ snippets["links/logout"] | default:resx["Sign_Out"] | escape }}' aria-roledescription='link' href='{% if homeurl%}/{{ homeurl }}{% endif %}{{ website.sign_out_url_substitution }}' title='{{ snippets["links/logout"] | default:resx["Sign_Out"] | escape }}'>
                      {{ snippets['links/logout'] | default: resx.Sign_Out | escape }}
                    </a>
                  </li>
                </ul>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="nav-link" aria-label='{{ snippets["links/login"] | default:resx["Sign_In"] | escape }}' aria-roledescription='link' href='{% if homeurl%}/{{ homeurl }}{% endif %}{{ website.sign_in_url_substitution }}'>
                  {{ snippets['links/login'] | default: resx.Sign_In | escape }}
                </a>
              </li>
            {% endif %}
          </ul>
          {% editable primary_nav %}
        </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- Search Modal -->
{% assign search_enabled = settings['Search/Enabled'] | boolean | default: true %}
{% if search_enabled %}
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content cccp-search-modal">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="searchModalLabel">
          <i class="fa-solid fa-magnifying-glass me-2" style="color: var(--cccp-gold);"></i>
          {{ snippets["Header/Search/Title"] | default: "Search CCCP Portal" | escape }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2">
        {% include 'Search', search_id: 'modal_search' %}
      </div>
    </div>
  </div>
</div>
{% endif %}

{% substitution %}
{% assign current_page = page.id %}
{% assign sr_page = sitemarkers.Search.id %}
{% assign forum_page = sitemarkers.Forums.id %}
{% if current_page %}
  {% if current_page == sr_page or current_page == forum_page %}
    {% assign section_class = 'section-landing-search' %}
    {% if current_page == forum_page %}
      {% assign section_class = 'section-landing-forums' %}
    {% endif %}
    <section class='page_section {{ section_class | h }} color-inverse'>
      <div class='row sectionBlockLayout sectionFixedStyle' style='display: flex; flex-wrap: wrap; text-align: center;'>
        <div class='container' style='display: flex; flex-wrap: wrap;'>
          <div class='col-lg-12 columnBlockLayout' style='display: flex; flex-direction: column; justify-content: center;'>
            {% if current_page == sr_page %}
              <h1 id='mainContent'>{% editable snippets 'Search/Title' default: resx["Discover_Contoso"] %}</h1>
              {% include 'Search', search_id: 'search_control' %}
            {% endif %}
          </div>
        </div>
      </div>
    </section>
  {% endif %}
{% endif %}
{% endsubstitution %}
<script type='text/javascript'>
  window.onload = function () {
    if (window.navigator.appName == 'Microsoft Internet Explorer' || window.navigator.userAgent.indexOf('Trident') > 0) {
      var searchElement = document.getElementById('search');
      if (searchElement != null) searchElement.setAttribute('href', '');
    }
  };
  function setHeight() {
    var windowHeight = window.innerHeight - 140;
    var navbar = document.getElementById('navbar');
    if (navbar) {
      navbar.style.maxHeight = windowHeight + 'px';
    }
  }
  window.addEventListener('resize', function (event) {
    setHeight();
  });
  
  // Auto-focus search input when modal opens
  document.addEventListener('DOMContentLoaded', function() {
    var searchModal = document.getElementById('searchModal');
    if (searchModal) {
      searchModal.addEventListener('shown.bs.modal', function () {
        var searchInput = document.getElementById('modal_search');
        if (searchInput) {
          searchInput.focus();
        }
      });
    }
  });
</script>
